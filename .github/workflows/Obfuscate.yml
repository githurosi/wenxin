name: Build Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 9 * * *"  # 北京时间17:00

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Check out the code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "lts/*"

    - name: Install dependencies
      run: |
        npm install -g npm@latest
        npm install javascript-obfuscator@latest

    - name: Secure clone BPB workjs
      run: |
        wget -O origin.js https://raw.githubusercontent.com/.../unobfuscated-worker.js
        echo "expected_sha256_hash origin.js" | sha256sum -c

    - name: Obfuscate with enhanced security
      run: |
        javascript-obfuscator origin.js --output _worker.js \
        --control-flow-flattening-threshold 0.75 \
        --dead-code-injection-threshold 0.4 \
        --string-array-encoding 'aes-256-cbc' || { echo "Obfuscation failed"; exit 1; }

    - name: Validate output
      run: |
        [ -s "_worker.js" ] || { echo "Output file empty"; exit 1; }
        node -e "require('./_worker.js')"

    - name: Compress output
      run: |
        terser _worker.js --compress --mangle --output _worker.min.js

    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        branch: main
        commit_message: 'chore(obfuscation): update worker panel (${{ github.sha }})'
        push_options: '--force'  # 强制推送覆盖历史